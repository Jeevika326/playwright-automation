image: gitpod/workspace-node

tasks:
  - name: Install Dependencies & Setup
    init: |
      # Install Node dependencies
      npm install
      
      # Install Playwright and its dependencies
      npm install -D @playwright/test
      
      # Install Playwright browsers and system dependencies
      npx playwright install
      npx playwright install-deps
      
      # Install dotenv for .env file support
      npm install dotenv
      
      # Create necessary directories
      mkdir -p playwright-report test-results

    command: |
      # Load environment variables from .env
      if [ -f ".env" ]; then
        set -a
        source .env
        set +a
        echo "‚úÖ Loaded credentials from .env file"
      else
        echo "‚ö†Ô∏è  No .env file found"
      fi

  - name: Run Tests & Generate Report
    command: |
      echo "Starting Playwright tests..."
      
      # Run the tests
      npx playwright test
      
      # Generate and open the HTML report
      npx playwright show-report
      
      # Create a timestamp for the report archive
      TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
      
      # Archive the test results and reports
      mkdir -p test-archives
      zip -r "test-archives/test-run-${TIMESTAMP}.zip" playwright-report/* test-results/*
      
      echo "üéØ Test execution completed!"
      echo "üìä HTML Report is available in playwright-report/"
      echo "üìÅ Test archive created: test-archives/test-run-${TIMESTAMP}.zip"
      
      # Display test summary
      echo "Test Summary:"
      grep "test" playwright-report/index.html | grep -o "Passed:[^<]*\|Failed:[^<]*\|Skipped:[^<]*"

  - name: Environment Check
    command: |
      echo "Checking test environment..."
      echo "Node version: $(node -v)"
      echo "npm version: $(npm -v)"
      echo "Playwright version: $(npx playwright -V)"

vscode:
  extensions:
    - "ms-playwright.playwright"
    - "dbaeumer.vscode-eslint"
    - "esbenp.prettier-vscode"
    - "github.vscode-pull-request-github"
    - "eamodio.gitlens"
    - "ms-vscode.vscode-typescript-tslint-plugin"
    - "christian-kohler.npm-intellisense"

ports:
  - port: 9323
    onOpen: ignore
  - port: 3000
    onOpen: ignore
  - port: 9222
    onOpen: ignore
    visibility: public
  - port: 443
    onOpen: ignore
    visibility: public

github:
  prebuilds:
    # enable for the master/default branch (defaults to true)
    master: true
    # enable for all branches in this repo (defaults to false)
    branches: true
    # enable for pull requests coming from this repo (defaults to true)
    pullRequests: true
    # enable for pull requests coming from forks (defaults to false)
    pullRequestsFromForks: true
    # add a check to pull requests (defaults to true)
    addCheck: true
    # add a "Review in Gitpod" button as a comment to pull requests (defaults to false)
    addComment: true
